# Настройка семантического поиска

## Обзор

Семантический поиск позволяет находить сообщения по смыслу, а не по точному совпадению слов. Например, запрос "как настроить API" найдет сообщения про "настройку интерфейса программирования".

## Архитектура

1. **Векторизация**: При создании сообщения генерируется эмбединг (векторное представление) текста через OpenAI Embeddings API
2. **Хранение**: Эмбединги хранятся в PostgreSQL с расширением pgvector
3. **Поиск**: Запрос векторизуется и сравнивается с эмбедингами сообщений по косинусному расстоянию

## Шаги настройки

### 1. Установить расширение pgvector в Supabase

1. Откройте Supabase Dashboard
2. Перейдите в Database → Extensions
3. Найдите `vector` и нажмите Enable
4. Или выполните SQL:
   ```sql
   CREATE EXTENSION IF NOT EXISTS vector;
   ```

### 2. Применить миграцию

Выполните миграцию `010_add_message_embeddings.sql` в Supabase SQL Editor.

### 3. Настроить автоматическую векторизацию

Обновите код создания сообщений, чтобы автоматически генерировать эмбединги. См. пример в `src/components/ChatRoom.tsx`.

### 4. (Опционально) Заполнить эмбединги для существующих сообщений

Используйте функцию `backfillEmbeddingsForRoom()` для векторизации старых сообщений.

## Использование

```typescript
import { searchMessagesSemantic } from '../lib/semantic-search'

// Поиск топ-5 сообщений
const results = await searchMessagesSemantic(roomId, 'поисковый запрос', 5)

results.forEach(msg => {
  console.log(`Similarity: ${msg.similarity.toFixed(3)} - ${msg.text}`)
})
```

## Стоимость

- **Векторизация**: ~$0.0001 за сообщение (OpenAI text-embedding-3-small)
- **Поиск**: Бесплатно (выполняется в PostgreSQL)
- **1000 сообщений**: ~$0.10 для векторизации всех

## Производительность

- **Генерация эмбединга**: ~100-300ms (API call)
- **Векторный поиск**: ~10-50ms (даже для 10,000 сообщений)
- **Индекс**: IVFFlat для быстрого приближенного поиска

## Ограничения

- Эмбединги генерируются асинхронно при создании сообщения
- Если эмбединг не создан, сообщение не будет найдено в семантическом поиске
- Для очень больших чатов (>100K сообщений) может потребоваться настройка индекса

