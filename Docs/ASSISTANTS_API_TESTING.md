# Тестирование Assistants API

## Обзор

Этот документ описывает процесс тестирования интеграции OpenAI Assistants API в проект Multi-User LLM Chat MVP.

## Предварительные требования

1. **OpenAI API ключ** должен быть настроен в переменных окружения (`VITE_OPENAI_API_KEY`)
2. **Supabase миграции** должны быть применены:
   - `014_add_assistants_support.sql`
   - `015_create_test_room_with_mock_files.sql`
3. **Авторизация** - необходимо войти в систему

## Этап 1: Подготовка тестовой комнаты

### Шаг 1: Применение миграций

1. Откройте Supabase Dashboard → SQL Editor
2. Выполните миграцию `014_add_assistants_support.sql`
3. Выполните миграцию `015_create_test_room_with_mock_files.sql`
4. Проверьте, что тестовая комната создана:
   ```sql
   SELECT * FROM rooms WHERE is_test_room = TRUE;
   ```

### Шаг 2: Доступ к тестовой комнате

1. Запустите приложение (`npm run dev`)
2. Войдите в систему через Google OAuth
3. Перейдите по адресу: `/test-assistants`
4. Должна открыться тестовая комната с заголовком "Test Assistants API"

## Этап 2: Тестирование базовой функциональности

### Тесткейс 1: Инициализация Assistant

**Цель:** Проверить создание Assistant с прикрепленными файлами

**Шаги:**
1. На странице тестовой комнаты найдите раздел "Файлы комнаты"
2. Убедитесь, что отображаются мокап-файлы (текст, PDF, изображение, CSV)
3. Нажмите кнопку "Инициализировать Assistant"
4. Дождитесь завершения инициализации

**Ожидаемый результат:**
- Кнопка показывает статус "Инициализация..."
- Появляется сообщение "✅ Assistant инициализирован! Загружено файлов: X"
- Файлы помечаются как "✅ Загружен в OpenAI"
- Отображается информация о настроенном Assistant

**Проверка в OpenAI Dashboard (опционально):**
- Откройте https://platform.openai.com/assistants
- Найдите созданного Assistant
- Проверьте, что к нему прикреплены файлы

### Тесткейс 2: Отправка простого сообщения

**Цель:** Проверить базовую работу Assistants API

**Шаги:**
1. После успешной инициализации Assistant
2. Введите простое сообщение: "Привет! Как дела?"
3. Нажмите "Отправить" или Enter
4. Дождитесь ответа

**Ожидаемый результат:**
- Сообщение отправляется (показывается "Отправка...")
- Через несколько секунд появляется ответ от "LLM (Assistants API)"
- Ответ должен быть релевантным и на русском языке (согласно системному промпту)

**Критерии успеха:**
- ✅ Ответ получен без ошибок
- ✅ Ответ сохранен в истории сообщений
- ✅ Статус показывает "✅ Сообщение отправлено и ответ получен"

## Этап 3: Тестирование инструментов Assistants API

### Тесткейс 3: Retrieval (Поиск по файлам)

**Цель:** Проверить, что Assistant может находить информацию в прикрепленных файлах

**Шаги:**
1. Нажмите кнопку "Тест Retrieval" (она автоматически заполнит поле сообщения)
2. Или введите вручную: "Что содержится в загруженных файлах? Перечисли основные темы и информацию."
3. Отправьте сообщение

**Ожидаемый результат:**
- Assistant отвечает, упоминая содержимое загруженных файлов
- Может упомянуть:
  - Описание проекта из текстового файла
  - Данные из CSV файла
  - Метаданные из JSON файла

**Критерии успеха:**
- ✅ Assistant ссылается на содержимое файлов
- ✅ Упоминаются конкретные детали из файлов
- ✅ Информация соответствует реальному содержимому файлов

**Пример хорошего ответа:**
> "В загруженных файлах содержится следующая информация:
> - Описание проекта Multi-User LLM Chat MVP из текстового файла, включая основные возможности и технологический стек
> - CSV файл с задачами проекта и их статусами
> - JSON файл с метаданными проекта
> - Диаграмма в формате изображения"

### Тесткейс 4: Code Interpreter (Анализ данных)

**Цель:** Проверить возможность выполнения кода для анализа данных

**Шаги:**
1. Нажмите кнопку "Тест Code Interpreter"
2. Или введите: "Проанализируй CSV файл с данными. Создай сводку и график."
3. Отправьте сообщение

**Ожидаемый результат:**
- Assistant анализирует CSV файл
- Предоставляет сводку данных
- Может создать описание графика или данных

**Критерии успеха:**
- ✅ Assistant успешно читает CSV файл
- ✅ Предоставляет анализ данных (статистику, сводку)
- ✅ Упоминает конкретные данные из CSV (названия задач, статусы, приоритеты)

**Пример хорошего ответа:**
> "Проанализировав CSV файл, я вижу следующие данные:
> - Всего задач: 5
> - Завершено: 3 задачи
> - В процессе: 1 задача
> - Запланировано: 1 задача
> - Высокий приоритет имеют 2 задачи
> 
> [Далее может следовать более детальная сводка]"

**Примечание:** Code Interpreter может создавать графики, но они не отображаются в чате напрямую. Assistant может описать, что он создал.

### Тесткейс 5: Function Calling (если реализован)

**Цель:** Проверить вызов пользовательских функций (опционально)

**Статус:** Функциональность Function Calling не реализована на этапе 1

**Когда будет реализовано:**
- Assistant сможет вызывать внешние API
- Assistant сможет получать данные из Supabase
- Assistant сможет выполнять действия в приложении

## Этап 4: Проверка обработки ошибок

### Тесткейс 6: Обработка ошибок API

**Цель:** Убедиться, что ошибки обрабатываются корректно

**Сценарии для проверки:**

1. **Неверный API ключ:**
   - Временно измените `VITE_OPENAI_API_KEY` на неверный
   - Попробуйте инициализировать Assistant
   - Должна появиться понятная ошибка

2. **Недоступная модель:**
   - В настройках комнаты измените модель на несуществующую (например, "gpt-999")
   - Попробуйте инициализировать Assistant
   - Должна появиться ошибка с объяснением

3. **Таймаут выполнения:**
   - Отправьте очень сложный запрос, который может занять много времени
   - Система должна корректно обработать таймаут (если настроен)

**Критерии успеха:**
- ✅ Ошибки отображаются пользователю в понятном формате
- ✅ Не крашит приложение
- ✅ Можно попробовать снова после исправления ошибки

## Этап 5: Проверка состояния и истории

### Тесткейс 7: Сохранение состояния Assistant

**Цель:** Проверить, что Assistant и Thread сохраняются между сессиями

**Шаги:**
1. Инициализируйте Assistant
2. Отправьте несколько сообщений
3. Обновите страницу (F5)
4. Попробуйте отправить новое сообщение

**Ожидаемый результат:**
- Assistant и Thread остаются доступными
- История сообщений сохраняется
- Можно продолжить беседу без повторной инициализации

**Проверка в БД:**
```sql
SELECT * FROM room_assistants WHERE room_id = '<room_id>';
-- Должна быть запись с assistant_id и thread_id
```

### Тесткейс 8: История сообщений в Thread

**Цель:** Проверить, что история сохраняется в OpenAI Thread

**Шаги:**
1. Отправьте несколько сообщений с разными вопросами
2. Задайте вопрос, требующий контекста предыдущих сообщений
3. Например: "А что я спрашивал раньше про файлы?"

**Ожидаемый результат:**
- Assistant помнит предыдущие сообщения
- Может ссылаться на ранее обсужденные темы
- Контекст сохраняется между сообщениями

## Критерии успешного прохождения Этапа 1

Этап 1 считается успешно пройденным, если:

- ✅ Все миграции применены без ошибок
- ✅ Тестовая комната создана и доступна
- ✅ Assistant успешно инициализируется с файлами
- ✅ Базовые сообщения обрабатываются корректно
- ✅ Retrieval работает (Assistant находит информацию в файлах)
- ✅ Code Interpreter работает (Assistant анализирует данные)
- ✅ Ошибки обрабатываются корректно
- ✅ Состояние сохраняется между сессиями
- ✅ История сообщений работает в Thread

## Известные ограничения

1. **Function Calling** - не реализован на этапе 1
2. **Обновление файлов** - при изменении файлов Assistant не обновляется автоматически (требует пересоздания)
3. **Размер файлов** - лимит OpenAI: 512MB на файл
4. **Количество файлов** - до 200 файлов в Assistant

## Следующие шаги

После успешного прохождения всех тесткейсов Этапа 1:

1. Переходим к Этапу 2: Механика подгрузки файлов
2. Реализуем загрузку реальных файлов через интерфейс
3. Интегрируем с Supabase Storage

## Поддержка

При возникновении проблем:

1. Проверьте консоль браузера (F12) на наличие ошибок
2. Проверьте Network tab для запросов к OpenAI API
3. Проверьте логи в Supabase Dashboard
4. Убедитесь, что все миграции применены
5. Проверьте, что API ключ OpenAI корректный и имеет доступ к Assistants API

