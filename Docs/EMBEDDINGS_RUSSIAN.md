# Настройка эмбеддингов для русскоязычного контента

## Текущая конфигурация

По умолчанию используется модель `text-embedding-3-small` (1536 измерений), которая поддерживает множество языков, включая русский.

## Рекомендации для русскоязычного и смешанного контента

### Вариант 1: Использовать `text-embedding-3-large` с уменьшенной размерностью (рекомендуется для русского)

Модель `text-embedding-3-large` показывает лучшее качество для неанглийских языков, включая русский. Однако из-за ограничений pgvector (максимум 2000 измерений для индексов), используем модель large с параметром `dimensions=1024`.

**Преимущества:**
- ✅ Лучшее понимание семантики русского языка (даже с уменьшенной размерностью)
- ✅ Лучше обрабатывает смешанный русско-английский контент
- ✅ 1024 измерения = помещается в индекс, при этом качество лучше чем у small модели
- ✅ Поддерживается OpenAI API с параметром `dimensions`

**Недостатки:**
- ❌ В 2 раза дороже (`text-embedding-3-small`: $0.02/1M токенов, `large`: $0.13/1M токенов)
- ❌ Требует изменения схемы БД (1024 вместо 1536 измерений)

**Как переключиться:**

1. Обновить `.env`:
```bash
VITE_OPENAI_EMBEDDING_MODEL=text-embedding-3-large
VITE_OPENAI_EMBEDDING_DIMENSIONS=1024
```

2. Применить миграцию `012_switch_to_large_embeddings.sql` для изменения размерности в БД

3. Пересоздать все эмбединги (через UI или консоль браузера)

### Вариант 2: Остаться на `text-embedding-3-small` (экономный)

`text-embedding-3-small` хорошо работает с русским языком для большинства задач. 

**Преимущества:**
- ✅ Дешевле (в 6.5 раз)
- ✅ Быстрее
- ✅ Уже настроено (1536 измерений)
- ✅ Хорошо работает с базовыми запросами

**Недостатки:**
- ⚠️ Может быть менее точной для сложных семантических запросов на русском

**Оптимизация для small модели:**
Можно уменьшить размерность для экономии (без потери качества для простых случаев):

```bash
# В .env
VITE_OPENAI_EMBEDDING_DIMENSIONS=1024
```

Затем применить миграцию:
```sql
ALTER TABLE public.messages ALTER COLUMN embedding TYPE vector(1024);
-- Пересоздать индексы...
```

### Вариант 3: Альтернативные модели (требуют другой инфраструктуры)

Для максимального качества на русском можно использовать специализированные модели:
- **GigaEmbeddings** (русский язык)
- **Navec** (компактная для русского)
- **FRIDA** (открытая модель для русского)

Но это требует:
- Собственного сервера/инфраструктуры
- Изменения кода для работы с другой API
- Больше сложности в поддержке

## Текущая реализация

Код автоматически определяет модель из переменной окружения:
- `VITE_OPENAI_EMBEDDING_MODEL` — выбор модели
- `VITE_OPENAI_EMBEDDING_DIMENSIONS` — переопределение размерности (опционально)

По умолчанию: `text-embedding-3-small` с размерностью модели по умолчанию.

## Рекомендация

Для начала оставайтесь на `text-embedding-3-small` и протестируйте качество поиска. Если результаты неудовлетворительные:
1. Переключитесь на `text-embedding-3-large`
2. Примените миграцию для изменения размерности
3. Пересоздайте эмбединги
4. Протестируйте снова

## Стоимость (примерно)

Для **1000 сообщений** по ~100 токенов каждое:
- `text-embedding-3-small`: ~$0.01
- `text-embedding-3-large`: ~$0.065

Разница не критична для небольших объемов, но для больших чатов может быть заметна.

